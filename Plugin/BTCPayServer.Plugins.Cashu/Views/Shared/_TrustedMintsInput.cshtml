@model string

@{
// model is a string separated by strings or newlines
var existingUrls = string.IsNullOrEmpty(Model)
? new List<string>()
: Model.Split(new[] { "\r\n", "\r", "\n", "," }, StringSplitOptions.RemoveEmptyEntries)
.Select(u => u.Trim())
.Where(u => !string.IsNullOrWhiteSpace(u))
.ToList();
}

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-7">
                <h6 class="mb-3">Add a Trusted Mint</h6>
                <div class="mb-3">
                    <label class="form-label">Mint URL</label>
                    <input id="mintUrl"
                           type="url"
                           class="form-control"
                           placeholder="https://mint.example.com" />
                    <span class="text-danger validation-error" style="display: none;"></span>
                </div>
                <button type="button"
                        class="btn btn-primary"
                        data-action="add-mint">
                    Add mint
                </button>
            </div>

            <div class="col-md-5 border-start-md">
                <h6 class="mb-3">Find a Mint</h6>
                <p class="text-muted mb-2">
                    Browse mints at bitcoinmints.com.
                </p>
                <a href="https://bitcoinmints.com/?tab=mints&showCashu=true"
                   class="btn btn-outline-primary d-inline-flex align-items-center gap-2"
                   target="_blank"
                   rel="noreferrer">
                    View Cashu Mints 
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         width="18" height="18" viewBox="0 0 24 24" 
                         fill="none" stroke="currentColor" stroke-width="2" 
                         stroke-linecap="round" stroke-linejoin="round" 
                         class="lucide lucide-square-arrow-out-up-right-icon lucide-square-arrow-out-up-right"
                    >
                        <path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"/>
                        <path d="m21 3-9 9"/>
                        <path d="M15 3h6v6"/>
                    </svg>
                </a>
                
            </div>
        </div>

        <hr class="my-4" />
        <h6 class="mb-3">Trusted Mints</h6>

        <div id="mintsContainer">
        </div>

        <textarea id="trustedMintsData"
                  name="TrustedMintsUrls"
                  style="display: none;">@string.Join("\n", existingUrls)</textarea>
    </div>
</div>

<template id="mintRowTemplate">
    <tr>
        <td>
            <div class="fw-semibold">Cashu Mint</div>
            <div class="text-muted small mint-url"></div>
        </td>
        <td class="text-end">
            <div>
                <button type="button" class="bg-transparent border-0 text-secondary" title="Mint info">
                        <svg xmlns="http://www.w3.org/2000/svg" 
                             width="20" height="20" viewBox="0 0 24 24" 
                             fill="none" stroke="currentColor" 
                             stroke-width="2" 
                             stroke-linecap="round" 
                             stroke-linejoin="round" 
                        >
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                </button>
                <button type="button"
                        class="bg-transparent border-0 text-danger remove-mint-btn"
                        title="Remove mint">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <path d="M5 6v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6"/>
                    </svg>
                </button>
            </div>
        </td>
    </tr>
</template>

<template id="emptyStateTemplate">
        <div class="text-muted d-flex flex-column gap-1 align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24" height="24" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round"
                 stroke-linejoin="round"
                 class="lucide lucide-landmark-icon lucide-landmark">
                <path d="M10 18v-7"/>
                <path d="M11.12 2.198a2 2 0 0 1 1.76.006l7.866 3.847c.476.233.31.949-.22.949H3.474c-.53 0-.695-.716-.22-.949z"/>
                <path d="M14 18v-7"/>
                <path d="M18 18v-7"/>
                <path d="M3 22h18"/>
                <path d="M6 18v-7"/>
            </svg>
            <span>No trusted mints yet.</span>
        </div>
</template>


<script>
    (function() {
        // init with data from server
        const initialData = document.getElementById('trustedMintsData').value;
        const startMints = initialData
            ? initialData.split('\n').map(u => u.trim()).filter(u => u.length > 0)
            : [];

        const mintsState = {
            mints: startMints.map((u, idx) => ({ id: idx, url: u })),
            idCounter: startMints.length
        };

        const elements = {
            mintUrl: document.getElementById('mintUrl'),
            mintsContainer: document.getElementById('mintsContainer'),
            trustedMintsData: document.getElementById('trustedMintsData'),
            addMintBtn: document.querySelector('[data-action="add-mint"]'),
            validationError: document.querySelector('.validation-error')
        };

        function showError(message) {
            if (elements.validationError) {
                elements.validationError.textContent = message;
                elements.validationError.style.display = 'block';
            }
        }

        function hideError() {
            if (elements.validationError) {
                elements.validationError.style.display = 'none';
            }
        }

        function addMint() {
            const url = elements.mintUrl.value.trim();

            if (!url) {
                showError('Please enter a mint URL');
                return;
            }

            // validate url
            try {
                const parsed = new URL(url);
                if (!parsed.protocol.startsWith('http')) {
                    showError('URL must start with http:// or https://');
                    return;
                }
            } catch (_) {
                showError('Invalid URL format');
                return;
            }

            // check for dupes
            if (mintsState.mints.some(m => m.url === url)) {
                showError('This mint is already in your trusted list');
                return;
            }

            hideError();

            mintsState.mints.push({
                id: mintsState.idCounter++,
                url: url
            });

            elements.mintUrl.value = '';
            elements.mintUrl.focus();
            updateUI();
        }

        function removeMint(id) {
            mintsState.mints = mintsState.mints.filter(m => m.id !== id);
            updateUI();
        }

        function updateUI() {
            if (mintsState.mints.length === 0) {
                const template = document.getElementById('emptyStateTemplate');
                const clone = template.content.cloneNode(true);
                elements.mintsContainer.innerHTML = '';
                elements.mintsContainer.appendChild(clone);
            } else {
                elements.mintsContainer.innerHTML = `
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>Mint</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="mintsTableBody"></tbody>
            </table>`;

                const tbody = document.getElementById('mintsTableBody');
                const template = document.getElementById('mintRowTemplate');

                mintsState.mints.forEach(m => {
                    const clone = template.content.cloneNode(true);

                    // WypeÅ‚nij dane
                    clone.querySelector('.mint-url').textContent = m.url;
                    const btn = clone.querySelector('.remove-mint-btn');
                    btn.dataset.mintId = m.id;
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        removeMint(m.id);
                    });

                    tbody.appendChild(clone);
                });
            }

            // update textarea
            elements.trustedMintsData.value = mintsState.mints
                .map(m => m.url)
                .join('\n');
        }

        if (elements.addMintBtn) {
            elements.addMintBtn.addEventListener('click', addMint);
        }

        if (elements.mintUrl) {
            elements.mintUrl.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addMint();
                }
            });

            elements.mintUrl.addEventListener('input', hideError);
        }

        // initialize ui 
        updateUI();
    })();
</script>
